
jobs:
- job: win
  pool:
    vmImage: vs2017-win2016
  timeoutInMinutes: 360
  strategy:
    maxParallel: 4
    matrix:
      win64:
        compiler: msvc2015
        arch: x86_64
        backend: ninja
  steps:

    - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
      displayName: Add conda to PATH

    - script: conda create --yes --quiet --name entwine
      displayName: Create conda environment

    - script: |
          call activate entwine
          conda config --set always_yes True --set show_channel_urls True
          conda config --add channels conda-forge
          conda install --yes --quiet --name entwine -c conda-forge pdal ninja
          choco uninstall gcc
      displayName: Install conda packages

    - script: |
          ECHO ON
          call activate entwine
          call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x86_amd64 -vcvars_ver=14.0
          cmake -Wno-dev -G "Ninja" ^
            -DCMAKE_INSTALL_PREFIX=D:/bld ^
            -DCMAKE_BUILD_TYPE=RelWithDebInfo ^
            -DBUILD_SHARED_LIBS=ON ^
            -Dgtest_force_shared_crt=ON .
      displayName: Configure CMake

    - script: |
          call activate entwine
          ninja
      displayName: Build
